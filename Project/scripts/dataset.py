#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è‡ªå®šä¹‰æ•°æ®é›†é…ç½®
ä¸ºYOLACT++åˆ›å»ºæ•°æ®é›†é…ç½®
"""

import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

import config

def get_yolact_dataset_config():
    """
    ç”ŸæˆYOLACT++æ ¼å¼çš„æ•°æ®é›†é…ç½®
    æ­¤é…ç½®å°†è¢«æ·»åŠ åˆ°YOLACTçš„data/config.pyä¸­
    """

    dataset_config = f"""
# Campus Objects Dataset Configuration
# Auto-generated by scripts/dataset.py

campus_objects_dataset = dataset_base.copy({{
    'name': 'Campus Objects',

    'train_images': '{config.PROCESSED_DATA_DIR / "train"}/',
    'train_info': '{config.PROCESSED_DATA_DIR / "train" / "annotations.json"}',

    'valid_images': '{config.PROCESSED_DATA_DIR / "val"}/',
    'valid_info': '{config.PROCESSED_DATA_DIR / "val" / "annotations.json"}',

    'test_images': '{config.PROCESSED_DATA_DIR / "test"}/',
    'test_info': '{config.PROCESSED_DATA_DIR / "test" / "annotations.json"}',

    'has_gt': True,
    'class_names': {config.CLASSES},
    'label_map': None  # Will use COCO format directly
}})

# Model configuration for campus objects
campus_objects_config = coco_base_config.copy({{
    'name': 'campus_objects_base',

    # Dataset
    'dataset': campus_objects_dataset,
    'num_classes': {config.NUM_CLASSES + 1},  # +1 for background

    # Image settings
    'max_size': {config.IMAGE_SIZE},
    'min_size': {config.IMAGE_SIZE},

    # Training settings
    'lr': {config.LEARNING_RATE},
    'batch_size': {config.BATCH_SIZE},
    'max_iter': {config.NUM_EPOCHS * 1000},  # Approximate

    # Freeze backbone
    'freeze_bn': True,

    # Other settings
    'backbone': resnet{config.BACKBONE[-2:]}_backbone,
    'name': 'campus_objects_yolact_plus',
}})
"""

    return dataset_config

def create_yolact_config_file(output_path=None):
    """åˆ›å»ºYOLACTé…ç½®æ–‡ä»¶"""
    if output_path is None:
        output_path = PROJECT_ROOT / "yolact_campus_config.py"

    dataset_config = get_yolact_dataset_config()

    with open(output_path, 'w', encoding='utf-8') as f:
        f.write("#!/usr/bin/env python3\n")
        f.write('# -*- coding: utf-8 -*-\n')
        f.write('"""\n')
        f.write('YOLACT++ Configuration for Campus Objects\n')
        f.write('This file should be integrated into yolact/data/config.py\n')
        f.write('"""\n\n')
        f.write(dataset_config)

    print(f"âœ“ YOLACT config file created: {output_path}")
    return output_path

def print_integration_instructions():
    """æ‰“å°é›†æˆè¯´æ˜"""
    print("\n" + "="*60)
    print(" Integration Instructions")
    print("="*60)
    print("\nTo integrate this dataset config into YOLACT++:")
    print("\n1. Open file: yolact/data/config.py")
    print("\n2. Add the following import at the top:")
    print("   from pathlib import Path")
    print("\n3. Copy the content from 'yolact_campus_config.py'")
    print("   and paste it at the end of yolact/data/config.py")
    print("\n4. When training, use:")
    print("   --config=campus_objects_config")
    print("="*60 + "\n")

if __name__ == "__main__":
    print("\nğŸ“ Creating YOLACT++ dataset configuration...")

    # åˆ›å»ºé…ç½®æ–‡ä»¶
    config_file = create_yolact_config_file()

    # æ‰“å°é›†æˆè¯´æ˜
    print_integration_instructions()

    print("âœ… Configuration file created successfully!")
    print(f"\nğŸ“„ Config file: {config_file}")
